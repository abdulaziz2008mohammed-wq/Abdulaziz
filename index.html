<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙØ±ÙÙˆØ¨ Ø§Ù„Ù’Ù‡ÙØ¯ÙØ§ÙŠÙØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --emerald-dark: #01261c; 
            --emerald-light: #064e3b;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fcf6ba, #aa771c);
            --gold-solid: #d4af37; 
            --glass: rgba(255, 255, 255, 0.95);
            --bg-body: #f4f1ea; 
            --text-color: #2c2c2c;
            --card-text: #2c2c2c;
        }
        [data-theme='dark'] {
            --emerald-dark: #011611; --emerald-light: #022c22;
            --glass: rgba(20, 20, 20, 0.98); --bg-body: #011611; 
            --text-color: #ecfdf5; --card-text: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: 0.3s; user-select: none !important; }
        body { 
            font-family: 'Tajawal', sans-serif; background: var(--bg-body); margin: 0; color: var(--text-color); 
            height: 100vh; overflow: hidden; background-image: url('https://www.transparenttextures.com/patterns/islamic-exercise.png'); 
        }

        header { 
            background: var(--emerald-dark); color: var(--gold-solid); padding: 20px 15px; text-align: center; 
            font-family: 'Amiri', serif; font-size: 1.6rem; border-bottom: 4px solid #d4af37; 
            position: fixed; top: 0; width: 100%; z-index: 1000;
        }

        .page { display: none; height: 100vh; overflow-y: auto; padding: 120px 20px 150px 20px; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }

        .card { 
            background: var(--glass); border: 2px solid var(--gold-solid); padding: 20px; border-radius: 20px; 
            text-align: right; margin-bottom: 20px; color: var(--card-text);
        }

        .btn-gold { 
            background: var(--gold-gradient); color: var(--emerald-dark); border: 1px solid var(--gold-solid);
            padding: 12px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%;
        }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¨Ø¶ */
        .recording-active { animation: pulse-red 0.8s infinite alternate !important; background: #e74c3c !important; }
        @keyframes pulse-red { from { transform: scale(1); } to { transform: scale(1.1); } }

        /* Ø£Ù…ÙˆØ§Ø¬ Ø§Ù„ØµÙˆØª */
        .audio-wave { display: none; align-items: flex-end; gap: 3px; height: 15px; }
        .is-playing .audio-wave { display: inline-flex; }
        .audio-wave span { width: 3px; background: var(--gold-solid); animation: wave-anim 1s infinite ease-in-out; }
        @keyframes wave-anim { 0%, 100% { height: 5px; } 50% { height: 15px; } }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; padding:20px; }
        input { user-select: text !important; width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--gold-solid); background: white; color: black; }
        
        .prayer-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; color: var(--card-text); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="create-room-modal" class="modal">
    <div class="card" style="width:100%; max-width:350px;">
        <h3 style="text-align:center; color:var(--emerald-light)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <input type="text" id="new-room-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©...">
        <input type="password" id="new-room-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±...">
        <button class="btn-gold" onclick="window.confirmCreateRoom()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</button>
        <button class="btn-gold" style="background:#888; margin-top:10px;" onclick="document.getElementById('create-room-modal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div id="auth-screen" style="position:fixed; inset:0; background:var(--emerald-dark); z-index:5000; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div class="card" style="width:100%; max-width:400px; text-align:center;">
        <h2 style="font-family:'Amiri'; color:var(--gold-solid); font-size:2.2rem;">Ø¯ÙØ±ÙÙˆØ¨ Ø§Ù„Ù’Ù‡ÙØ¯ÙØ§ÙŠÙØ©</h2>
        <input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„...">
        <input type="tel" id="reg-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
        <input type="text" id="reg-code" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)...">
        <button class="btn-gold" onclick="window.registerUser()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†</button>
    </div>
</div>

<div id="main-app-interface" style="display:none;">
    <header>Ø¯ÙØ±ÙÙˆØ¨ Ø§Ù„Ù’Ù‡ÙØ¯ÙØ§ÙŠÙØ©</header>
    
    <div id="page-rooms" class="page active">
        <div id="rooms-list"></div>
        <button id="add-room-btn" style="position:fixed; bottom:150px; left:20px; width:60px; height:60px; border-radius:50%; background:var(--gold-gradient); border:none; font-size:2rem; display:none;" onclick="window.openCreateModal()">+</button>
    </div>

    <div id="page-prayer" class="page">
        <div class="card" style="text-align: center;">
            <h3 style="font-family:'Amiri'; color:var(--emerald-light);">ğŸ•‹ Ù…ÙÙˆØ§Ù‚ÙŠØªÙ Ø§Ù„ØµÙ‘ÙÙ„Ø§Ø©Ù</h3>
            <div id="prayer-times-cont">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª...</div>
        </div>
    </div>

    <div id="page-settings" class="page">
        <div class="card" id="user-info-card"></div>
        <button class="btn-gold" onclick="window.toggleTheme()">ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ (Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ)</button>
        <button class="btn-gold" onclick="window.logout()" style="background: #e74c3c; color: white; margin-top:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        <div style="margin-top: 30px; text-align: center; color: white; font-family: 'Amiri';">
            <p style="color: var(--gold-solid);">Ø¨ÙØ¥ÙØ´Ù’Ø±ÙØ§ÙÙ ÙˆÙØªÙØ·Ù’ÙˆÙÙŠØ±Ù:</p>
            <p>Ø£ÙØ­Ù’Ù…ÙØ¯Ù Ø§Ù„Ù’Ù…ÙØ·ÙÙˆÙ‘ÙØ±Ù | Ø¹ÙØ¨Ù’Ø¯Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØ¨ÙØ±Ù’Ù…ÙØ¬Ù</p>
        </div>
    </div>

    <nav style="position:fixed; bottom:0; width:100%; background:var(--emerald-dark); display:flex; justify-content:space-around; padding:10px; z-index:2000;">
        <button onclick="window.showPage('rooms')" style="color:var(--gold-solid); background:none; border:none;">ğŸ <br>Ø§Ù„Ø­Ù„Ù‚Ø§Øª</button>
        <button onclick="window.showPage('prayer')" style="color:var(--gold-solid); background:none; border:none;">ğŸ•Œ<br>Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</button>
        <button onclick="window.showPage('settings')" style="color:var(--gold-solid); background:none; border:none;">âš™ï¸<br>Ø­Ø³Ø§Ø¨ÙŠ</button>
    </nav>
</div>

<div id="chat-ui" style="position:fixed; inset:0; background:var(--bg-body); z-index:3500; display:none; flex-direction:column;">
    <header style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
        <div onclick="window.closeChat()" style="cursor:pointer;">âœ•</div>
        <span id="room-chat-title"></span>
        <div style="width:30px;"></div>
    </header>
    <div id="room-msgs-cont" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column;"></div>
    <div style="padding:15px; background:var(--glass); display:flex; gap:10px; align-items:center;">
        <input type="text" id="room-input" style="flex:1" placeholder="Ø±Ø³Ø§Ù„Ø©...">
        <button id="rec-btn-room" class="btn-gold" style="width:50px; border-radius:50%;" onclick="window.toggleRecord('room')">ğŸ¤</button>
        <button class="btn-gold" style="width:70px;" onclick="window.sendRoomMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyB6aPF7qqqiiHMGXR5b3boCrRa7VcdDJwE", 
        databaseURL: "https://myprochat-6d05c-default-rtdb.firebaseio.com", 
        projectId: "myprochat-6d05c"
    };
    const app = initializeApp(firebaseConfig); 
    const db = getDatabase(app);

    let user = JSON.parse(localStorage.getItem('noor_user')) || { name: "", role: "" };
    let activeRoomId = null;
    let mediaRecorder;

    // --- Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© ---
    window.openCreateModal = () => { document.getElementById('create-room-modal').style.display = 'flex'; };
    window.confirmCreateRoom = () => {
        const name = document.getElementById('new-room-name').value;
        const pass = document.getElementById('new-room-pass').value;
        if(name && pass) {
            push(ref(db, 'rooms'), { name, pass, supervisor: user.name });
            document.getElementById('create-room-modal').style.display = 'none';
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­");
        }
    };

    // --- Ø¥ØµÙ„Ø§Ø­ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ---
    async function fetchPrayers() {
        try {
            const res = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Cairo&country=Egypt&method=5');
            const data = await res.json();
            const timings = data.data.timings;
            const names = { Fajr: "Ø§Ù„ÙØ¬Ø±", Sunrise: "Ø§Ù„Ø´Ø±ÙˆÙ‚", Dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", Asr: "Ø§Ù„Ø¹ØµØ±", Maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", Isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡" };
            let html = "";
            for(let k in names) {
                html += `<div class="prayer-item"><span>${names[k]}</span><span>${timings[k]}</span></div>`;
            }
            document.getElementById('prayer-times-cont').innerHTML = html;
        } catch(e) { document.getElementById('prayer-times-cont').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; }
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ù†Ø¨Ø¶ (ÙƒÙ…Ø§ Ù‡Ùˆ) ---
    window.toggleRecord = async (context) => {
        const btn = document.getElementById('rec-btn-room');
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            btn.classList.add('recording-active');
            mediaRecorder.onstop = () => btn.classList.remove('recording-active');
        } else { mediaRecorder.stop(); }
    };

    // --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† (ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ†) ---
    window.toggleTheme = () => {
        const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', theme);
    };

    window.registerUser = () => {
        const n = document.getElementById('reg-name').value;
        const code = document.getElementById('reg-code').value;
        if(n.length < 3) return alert("Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±");
        user = { name: n, role: (code === "AM/SA_1" ? "supervisor" : "student") };
        localStorage.setItem('noor_user', JSON.stringify(user));
        location.reload();
    };

    if(user.name) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app-interface').style.display = 'block';
        if(user.role === 'supervisor') document.getElementById('add-room-btn').style.display = 'block';
        document.getElementById('user-info-card').innerHTML = `<h3>${user.name}</h3><p>Ø§Ù„Ø±ØªØ¨Ø©: ${user.role === 'supervisor' ? 'Ù…Ø´Ø±Ù' : 'Ø·Ø§Ù„Ø¨'}</p>`;
        onValue(ref(db, 'rooms'), snap => {
            const list = document.getElementById('rooms-list'); list.innerHTML = "";
            snap.forEach(child => {
                const r = child.val();
                list.innerHTML += `<div class="card"><b>${r.name}</b><br><button class="btn-gold" onclick="window.enterRoom('${child.key}','${r.name}','${r.supervisor}')">Ø¯Ø®ÙˆÙ„</button></div>`;
            });
        });
        fetchPrayers();
    }

    window.showPage = p => { document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); };
    window.enterRoom = (id, name, supervisor) => { activeRoomId = id; document.getElementById('chat-ui').style.display = 'flex'; document.getElementById('room-chat-title').innerText = name; };
    window.closeChat = () => document.getElementById('chat-ui').style.display = 'none';
    window.logout = () => { localStorage.clear(); location.reload(); };
</script>
</body>
</html>
